---
title: "a3_task2_leonardo_feitosa"
author: "Leonardo Feitosa"
date: "18/02/2021"
output: 
  html_document:
    theme: journal
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(raster)
library(tidyverse)
library(here)
library(fasterize)
library(sf)
library(janitor)
library(rnaturalearthdata)
library(rnaturalearth)
library(rgeos)
```


## Read in the data

```{r}
cetaceans <- list.files(path = here("data", "ca_cetaceans"),
                       pattern = "*.tif",
                       full.names = TRUE)

cet_stack <- raster::stack(cetaceans)

plot(cet_stack)
```



```{r}
## Setting probability threshold
is_habitat <- function(x, thresh = 0.7) {
  y <- ifelse(x >= thresh, 1, 0)
  return(y)
}

# Filter rasters for the 0.7 threshold
cet <- calc(cet_stack, fun = is_habitat)

# Calculate cetacean species richness
cet_new <- calc(cet, fun = sum, na.rm = T)

plot(cet)
plot(cet_new)
```

```{r}
# Create dataframes from the rasters
richness_df <- raster::rasterToPoints(cet_new) %>% 
  as.data.frame()

## Get map from rnaturalearth
california <- ne_countries(country = "united states of america", returnclass = "sf")

california %>% st_crs()


# Test
ggplot() +
  geom_raster(data = cet_df, aes(x = x, y = y)) +
  geom_raster(data = habitat_df, aes(x = x, y = y))

# Make the plot
ggplot(data = california) +
  geom_raster(data = richness_df, aes(x = x, y = y, fill = layer)) +
  geom_sf() +
  scale_fill_gradient(low = "white", high = "slateblue") +
  coord_sf(xlim = c(-125.5, -116),
           ylim = c(32.3, 37.8),
           expand = T) +
  labs(title = "Probability of occurrences for cetacean species in California",
       fill = "Richness") +
  theme_bw() +
  theme(axis.title = element_blank(),
        panel.grid = element_blank())
```



















