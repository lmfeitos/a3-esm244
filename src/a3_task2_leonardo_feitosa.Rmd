---
title: "a3_task2_leonardo_feitosa"
author: "Leonardo Feitosa"
date: "18/02/2021"
output: 
  html_document:
    theme: journal
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(raster)
library(tidyverse)
library(here)
library(fasterize)
library(sf)
library(janitor)
library(rnaturalearth)
library(rgeos)
```


## Read in the data

```{r}
cetaceans <- list.files(path = here("data", "ca_cetaceans"),
                       pattern = "*.tif",
                       full.names = TRUE)

cet_stack <- raster::stack(cetaceans)

plot(cet_stack)
```

```{r}
## Calculating means
cet_means <- calc(cet_stack, fun = mean, na.rm = T)

plot(cet_means)
```



```{r}
## Setting probability threshold
is_habitat <- function(x, thresh = 0.6) {
  y <- ifelse(x >= thresh, 1, NA)
  return(y)
}

cet <- calc(cet_means, fun = is_habitat)

plot(cet)
```

```{r}
# Create dataframes from the rasters

cet_df <- raster::rasterToPoints(cet_means) %>% 
  as.data.frame()

habitat_df <- raster::rasterToPoints(cet) %>% 
  as.data.frame()

## Get map from rnaturalearth
california <- ne_countries(country = "united states of america", returnclass = "sf")

california %>% st_crs()


# Test
ggplot() +
  geom_raster(data = cet_df, aes(x = x, y = y, fill = layer)) +
  geom_raster(data = habitat_df, aes(x = x, y = y))

# Make the plot
ggplot(data = california) +
  geom_sf() +
  geom_raster(data = cet_df, aes(x = x, y = y, fill = layer)) +
  geom_raster(data = habitat_df, aes(x = x, y = y)) +
  coord_sf() +
  theme_bw()
```



















